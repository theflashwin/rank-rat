global
    lua-load /usr/local/etc/haproxy/router.lua

defaults
    mode http
    timeout connect 5s
    timeout client  1h
    timeout server  1h
    option http-keep-alive

# ---------------------------------------------------------------------
# RESOLVERS (Required for Render.com/AWS DNS resolution)
# ---------------------------------------------------------------------
resolvers docker_dns
    parse-resolv-conf
    resolve_retries 3
    timeout resolve 1s
    hold valid 10s

# ---------------------------------------------------------------------
# REDIS BRIDGE (Lua -> Localhost -> Real Redis)
# ---------------------------------------------------------------------
# listen redis_bridge
#     bind 127.0.0.1:6379
#     mode tcp
#     # HAProxy handles the DNS resolution here asynchronously
#     server redis_main red-d4v3gdre5dus73a6bke0:6379 check inter 5s resolvers docker_dns

# ---------------------------------------------------------------------
# MAIN WEBSOCKET FRONTEND
# ---------------------------------------------------------------------
frontend ws_in
    bind :10000
    mode http

    # Handle CORS preflight (OPTIONS)
    http-request return status 204 hdr Access-Control-Allow-Origin "*" hdr Access-Control-Allow-Methods "GET, POST, OPTIONS" hdr Access-Control-Allow-Headers "Content-Type, Authorization" if METH_OPTIONS

    # CORS headers on responses
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"

    # Execute Lua to route logic
    http-request lua.route_ws

    # Route based on variable set by Lua
    use_backend %[var(txn.backend_name)]

# ---------------------------------------------------------------------
# BACKENDS
# ---------------------------------------------------------------------
backend server0
    mode http
    server sink rank-rat:10000

backend server1
    mode http
    server ws1 rank-rat-game-server-alpha:10000

backend server2
    mode http
    server ws2 rank-rat-game-server-beta:10000
