# production proxy

global
    lua-load /usr/local/etc/haproxy/router.lua

defaults
    mode http
    timeout connect 5s
    timeout client  1h
    timeout server  1h
    option http-keep-alive

frontend ws_in
    bind :10000
    mode http

    # Handle CORS preflight (OPTIONS) requests with headers on the response
    http-request return status 204 hdr Access-Control-Allow-Origin "*" hdr Access-Control-Allow-Methods "GET, POST, OPTIONS" hdr Access-Control-Allow-Headers "Content-Type, Authorization" if METH_OPTIONS

    # Ensure CORS headers on every response (not just OPTIONS)
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"

    # extract room_id automatically and set txn.backend_name
    http-request lua.route_ws

    # route to backend selected by Lua
    use_backend %[var(txn.backend_name)]

    default_backend server0

backend server0
    mode http
    # Add CORS headers to responses from backend
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    server sink rank-rat-sink-server.internal:10000

backend server1
    mode http
    # Add CORS headers to responses from backend
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    server ws1 rank-rat-game-server-alpha.internal:10000

backend server2
    mode http
    # Add CORS headers to responses from backend
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type, Authorization"
    server ws2 rank-rat-game-server-beta.internal:10000
